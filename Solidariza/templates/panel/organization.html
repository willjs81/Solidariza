{% extends "base.html" %}

{% block title %}Minha Organização{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">
        <i class="fas fa-building"></i> Minha Organização: {{ org.name }}
    </h1>

    <!-- Estatísticas Principais -->
    <div class="columns">
        <div class="column">
            <div class="box has-text-centered">
                <p class="heading">Total de Colaboradores</p>
                <p class="title is-3 has-text-primary">{{ total_collaborators }}</p>
            </div>
        </div>
        <div class="column">
            <div class="box has-text-centered">
                <p class="heading">Assistidos Ativos</p>
                <p class="title is-3 has-text-success">{{ active_beneficiaries }}</p>
            </div>
        </div>
        <div class="column">
            <div class="box has-text-centered">
                <p class="heading">Distribuições (30d)</p>
                <p class="title is-3 has-text-info">{{ recent_distributions }}</p>
            </div>
        </div>
        <div class="column">
            <div class="box has-text-centered">
                <p class="heading">Eventos (30d)</p>
                <p class="title is-3 has-text-warning">{{ recent_events }}</p>
            </div>
        </div>
    </div>

    <!-- Estrutura Organizacional -->
    <div class="box">
        <h2 class="subtitle">
            <i class="fas fa-sitemap"></i> Estrutura Organizacional
        </h2>
        
        <div class="columns">
            <div class="column">
                <div class="box has-text-centered">
                    <p class="heading">Administradores</p>
                    <p class="title is-4 has-text-danger">{{ admins }}</p>
                </div>
            </div>
            <div class="column">
                <div class="box has-text-centered">
                    <p class="heading">Gerentes</p>
                    <p class="title is-4 has-text-warning">{{ managers }}</p>
                </div>
            </div>
            <div class="column">
                <div class="box has-text-centered">
                    <p class="heading">Usuários</p>
                    <p class="title is-4 has-text-info">{{ users }}</p>
                </div>
            </div>
            <div class="column">
                <div class="box has-text-centered">
                    <p class="heading">Assistidos Inativos</p>
                    <p class="title is-4 has-text-grey">{{ inactive_beneficiaries }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Colaboradores -->
    <div class="box">
        <div class="level">
            <div class="level-left">
                <h2 class="subtitle">
                    <i class="fas fa-users-cog"></i> Colaboradores ({{ total_collaborators }})
                </h2>
            </div>
            {% if request.user.is_superuser or request.user.role in 'ADMIN,MANAGER' %}
            <div class="level-right">
                <a class="button is-primary" href="{% url 'panel:collaborator_create' %}">
                    <i class="fas fa-plus"></i> Novo Colaborador
                </a>
            </div>
            {% endif %}
        </div>
        
        {% if collaborators %}
        <div class="table-container">
            <table class="table is-fullwidth is-striped">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Papel</th>
                        <th>Ativo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for collaborator in collaborators %}
                    <tr>
                        <td>
                            <strong>{{ collaborator.get_full_name|default:collaborator.username }}</strong>
                        </td>
                        <td>{{ collaborator.email|default:"-" }}</td>
                        <td>
                            {% if collaborator.role == "admin" %}
                                <span class="tag is-danger">
                                    <i class="fas fa-user-shield"></i> Administrador
                                </span>
                            {% elif collaborator.role == "manager" %}
                                <span class="tag is-warning">
                                    <i class="fas fa-user-tie"></i> Gerente
                                </span>
                            {% else %}
                                <span class="tag is-info">
                                    <i class="fas fa-user"></i> Usuário
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if collaborator.is_active %}
                                <span class="tag is-success">
                                    <i class="fas fa-check-circle"></i> Ativo
                                </span>
                            {% else %}
                                <span class="tag is-danger">
                                    <i class="fas fa-times-circle"></i> Inativo
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="buttons are-small">
                                <a class="button is-info is-small" href="{% url 'panel:collaborator_detail' collaborator.pk %}">
                                    <i class="fas fa-eye"></i> Ver
                                </a>
                                {% if request.user.is_superuser or request.user.role in 'ADMIN,MANAGER' %}
                                <a class="button is-warning is-small" href="{% url 'panel:collaborator_edit' collaborator.pk %}">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="notification is-info is-light">
            <i class="fas fa-info-circle"></i> Nenhum colaborador encontrado.
        </div>
        {% endif %}
    </div>

    <!-- Assistidos -->
    <div class="box">
        <div class="level">
            <div class="level-left">
                <h2 class="subtitle">
                    <i class="fas fa-heart"></i> Assistidos Vinculados ({{ total_beneficiaries }})
                </h2>
            </div>
            {% if request.user.is_superuser or request.user.role in 'ADMIN,MANAGER' %}
            <div class="level-right">
                <a class="button is-success" href="{% url 'panel:beneficiary_create' %}">
                    <i class="fas fa-plus"></i> Novo Assistido
                </a>
            </div>
            {% endif %}
        </div>
        
        {% if beneficiaries %}
        <div class="table-container">
            <table class="table is-fullwidth is-striped">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Identificador</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for beneficiary in beneficiaries %}
                    <tr>
                        <td><strong>{{ beneficiary.name }}</strong></td>
                        <td>
                            {% if beneficiary.identifier %}
                                <span class="tag is-primary">{{ beneficiary.identifier }}</span>
                            {% elif beneficiary.document %}
                                <span class="tag is-info">{{ beneficiary.document }}</span>
                            {% else %}
                                <span class="tag is-light">ID: #{{ beneficiary.id }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if beneficiary.active %}
                                <span class="tag is-success">
                                    <i class="fas fa-check-circle"></i> Ativo
                                </span>
                            {% else %}
                                <span class="tag is-danger">
                                    <i class="fas fa-times-circle"></i> Inativo
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <a class="button is-info is-small" href="{% url 'panel:beneficiary_detail' beneficiary.pk %}">
                                <i class="fas fa-eye"></i> Ver Detalhes
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-4">
            <a href="{% url 'panel:beneficiary_list' %}" class="button is-primary">
                <i class="fas fa-list"></i> Ver Lista Completa
            </a>
        </div>
        {% else %}
        <div class="notification is-info is-light">
            <i class="fas fa-info-circle"></i> Nenhum assistido vinculado a esta organização ainda.
            <div class="mt-2">
                <a href="{% url 'panel:beneficiary_create' %}" class="button is-primary is-small">
                    <i class="fas fa-plus"></i> Cadastrar Primeiro Assistido
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Ações Rápidas -->
    <div class="box">
        <h2 class="subtitle">
            <i class="fas fa-bolt"></i> Ações Rápidas
        </h2>
        <div class="buttons">
            <a href="{% url 'panel:collaborators_page' %}" class="button is-primary">
                <i class="fas fa-users-cog"></i> Gerenciar Colaboradores
            </a>
            <a href="{% url 'panel:beneficiary_list' %}" class="button is-success">
                <i class="fas fa-heart"></i> Gerenciar Assistidos
            </a>
            <a href="{% url 'panel:family_list' %}" class="button is-info">
                <i class="fas fa-users"></i> Gerenciar Famílias
            </a>
            <a href="{% url 'panel:events_list' %}" class="button is-warning">
                <i class="fas fa-calendar-alt"></i> Gerenciar Eventos
            </a>
            {% if request.user.is_superuser or request.user.role in 'ADMIN,MANAGER' %}
            <a href="{% url 'panel:stock_page' %}" class="button is-link">
                <i class="fas fa-boxes"></i> Controlar Estoque
            </a>
            {% endif %}
            <a href="{% url 'panel:reports_page' %}" class="button is-dark">
                <i class="fas fa-chart-bar"></i> Ver Relatórios
            </a>
        </div>
    </div>
</div>
{% endblock %}